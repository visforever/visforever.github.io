<!DOCTYPE html>
<!-- Refer to url=https://yetanmoney.com/ Thanks a lot, upperclassman!-->
<html lang="zh-CN">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Note Details</title>

	<link rel="stylesheet" id="wp-block-library-css"
		href="../../blog/blogCSS/wp-includes.css.dist.block-library.style.min.css" type="text/css" media="all">
	<link rel="stylesheet" id="type-fonts-css" href="../../blog/blogCSS/t-font.css" type="text/css" media="all">
	<link rel="stylesheet" id="type-material-icons-css" href="../../blog/blogCSS/icon.css" type="text/css" media="all">
	<link rel="stylesheet" id="type-social-icons-css"
		href="../../blog/blogCSS/wp-content.themes.type-plus.fonts.socicon.min.css" type="text/css" media="all">
	<link rel="stylesheet" id="type-style-css" href="../../blog/blogCSS/wp-content.themes.type-plus.style.css"
		type="text/css" media="all">

	<!--MarkDown: https://maxiang.io/ 转换为html后，下载的css---->
	<link rel="stylesheet" href="../../assets/markdownStyle/marxico ver1.0.css">

	<!--Code 美化下载的css-->
	<link rel="stylesheet" type="text/css" href="../../assets/google-code-prettify/skins/desert.css">


	<link rel="stylesheet" id="type-blocks-style-css"
		href="../../blog/blogCSS/wp-content.themes.type-plus.inc.css.blocks.css" type="text/css" media="all">
	<link rel="stylesheet" id="type-slider-css-css"
		href="../../blog/blogCSS/wp-content.themes.type-plus.inc.slick.slick.min.css" type="text/css" media="all">
	<link rel="stylesheet" id="jetpack_css-css" href="../../blog/blogCSS/wp-content.plugins.jetpack.css.jetpack.css"
		type="text/css" media="all">

	<script type="text/javascript" src="../../blog/blogJS/wp-includes.js.jquery.jquery.js"></script>
	<script type="text/javascript" src="../../blog/blogJS/wp-includes.js.jquery.jquery-migrate.min.js"></script>
	
	<link rel="stylesheet" id="type-style-inline-css" href="../../blog/blogCSS/belowMeta01.css" type="text/css" media="all">
	<link rel="stylesheet" href="../../blog/blogCSS/belowMeta02.css" type="text/css" media="all">
	<link rel="stylesheet" href="../../blog/blogCSS/belowMeta03.css" type="text/css" media="all">
	<link rel="stylesheet" href="../../blog/blogCSS/belowMeta04.css" type="text/css" media="all">
	<link rel="stylesheet" href="../../blog/blogCSS/belowMeta05.css" type="text/css" media="all">
	<link rel="stylesheet" href="../../blog/blogCSS/belowMeta06.css" type="text/css" media="all">

	<link rel="shortcut icon" href="../../blog/favicon.ico?fit=32%2C32&amp;ssl=1" sizes="32x32">
	<link rel="icon" href="../../blog/favicon.ico?fit=32%2C32&amp;ssl=1" sizes="32x32">
	<link rel="icon" href="../../blog/favicon2.png?fit=192%2C192&amp;ssl=1" sizes="192x192">
	<link rel="shortcut icon" href="../../blog/favicon4.png?fit=192%2C192&amp;ssl=1" sizes="192x192">

	<link rel="apple-touch-icon-precomposed" href="../../blog/favicon3.png?fit=180%2C180&amp;ssl=1">

	<meta name="msapplication-TileImage" content="../../blog/favicon4.png?fit=270%2C270&amp;ssl=1">


	</head>

<!--重要，class不一样，后面影响样式，比如class:single对 entry-meta 影响间距-->

<body onload="PR.prettyPrint()"
	class="home blog  post-template-default single single-post single-format-standard wp-custom-logo fimg-classic hfeed header-layout2 content-sidebar">

	<div id="page" class="site">

		<header id="masthead" class="site-header has-header-image">

			<div class="home-site-title-centered">

				<div class="site-branding">
					<h1 class="site-title site-logo">
						<a href="#" class="custom-logo-link" rel="home">
							<img height="50" width="50" src="../../blog/favicon.ico" class="custom-logo" alt="ALTTAO">
						</a>
					</h1>

					<p class="site-description">能登上金字塔的生物只有两种 - 鹰和蜗牛</p>
					<p class="site-description">There are only two creatures who can surmount the pyramids - the eagle and the snail.</p>
					
				</div><!-- #site-branding -->

				<!-- #header bg-image -->
				<div class="header-image" style="background-image:url('../../blog/blog bg/blogbg6.jpg')"></div>

				<!-- 也可以用
					<div style="height:400px; background-image:url('../../blog/blog bg/blogbg3.jpg');"></div>
				-->


			</div>

		</header><!-- #masthead -->


		<div id="content" class="site-content">
			<div class="container">
				<!--控制container的空间分布文件在wp-content.themes.type-plus.style.css，搜索：/*tao即可-->
				<div class="inside">

					<div id="primary" class="content-area">
						<main id="main" class="site-main">

							<article id="post-2676"
								class="post-2676 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">


								<header class="entry-header">
									<h1 class="entry-title">
										<!--第1/3处修改(1)：p-->
										<!--此处要修改blog标题-->
										<span>多进程处理程序（替换多线程）</span>
									</h1>
									<div class="entry-meta">
										<span class="byline">
											<span class="author vcard">

												<span class="screen-reader-text">Author</span>
												<a class="url fn n" href="https://tideal.github.io/">tao</a>

											</span>
											&nbsp;&nbsp;
											<!--第2/3处修改(1)：p-->
											<!--此处要修改blog标题-->
											<time>Aug. 2022</time>
										</span>

									</div>
								</header>
								<!-- .entry-header -->


								<div class="entry-content">
								<!--第3/3处修改(段)：p-->
								<!--此处要修改blog标题-->

									
									<!--1. 标题移动到上面-->
									<!--2. 代码块，单独处理一下-->
									
									<!--Markdown内容开始((((-->
	

<div id='preview-contents' class='note-content'>
                        
                    

<hr>

<p><strong><code>问题</code></strong>：之前将一天的数据以小时（hour）为单位，划分了24个子集合。后来发现单个处理非常耗时，一旦有了新的想处理的字段，就需要再手动执行非常麻烦。 <br>
<strong><code>解决方法1</code></strong>：使用线程解决，已经在DP04进行了介绍。但是实际处理的时候发现非常难受的是，CPU的占用率并没有提高（也就是说，CPU并没有发挥作用）。后来进行了检查和重写。找到了解决方法2。 <br>
<strong><code>解决方法2</code></strong>：使用多进程解决。下面仔细介绍多进程的解决方法。</p>

<hr>

<div><div class="toc"><div class="toc">
<ul>
<li><ul>
<li><ul>
<li><a href="#">多进程替代多线程</a><ul>
<li><a href="#学习引例1">学习引例1</a></li>
<li><a href="#学习引例2">学习引例2</a></li>
<li><a href="#下面具体应用到我们的程序上">下面具体应用到我们的程序上</a><ul>
<li><a href="#程序11">程序1.1</a></li>
<li><a href="#程序12">程序1.2</a></li>
<li><a href="#程序13">程序1.3</a></li>
<li><a href="#程序2">程序2</a></li>
</ul>
</li>
<li><a href="#附录工具">附录工具</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>

<h4 id="学习引例1">学习引例1</h4>

<p><strong>例（1/2）</strong>：程序</p>

<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line"><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process     <span class="hljs-comment"># 多进程的类</span>
</div><div class="hljs-line"><span class="hljs-keyword">import</span> time
</div><div class="hljs-line"><span class="hljs-keyword">import</span> random
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_fun</span><span class="hljs-params">(name)</span>:</span>
</div><div class="hljs-line">    <span class="hljs-comment"># 随机等待1~5秒</span>
</div><div class="hljs-line">    time.sleep(random.randrange(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>))
</div><div class="hljs-line">    print(f<span class="hljs-string">"我是{name}子进程！"</span>)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
</div><div class="hljs-line">    process_list = []    <span class="hljs-comment"># 存放开启的进程</span>
</div><div class="hljs-line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>):
</div><div class="hljs-line">        <span class="hljs-comment"># 进程中的参数args表示调用对象的位置参数元组.注意：元组中只有一个元素时结尾要加","逗号</span>
</div><div class="hljs-line">        p = Process(target=test_fun, args=(f<span class="hljs-string">"son{i+1}"</span>,))
</div><div class="hljs-line">        p.start()
</div><div class="hljs-line">        process_list.append(p)
</div><div class="hljs-line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> process_list:
</div><div class="hljs-line">        i.join()    <span class="hljs-comment"># 阻塞每个子进程，主进程会等待所有子进程结束再结束主进程</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    print(<span class="hljs-string">"主进程结束！"</span>)
</div></code></pre>

<p><strong>学习引例（1/2）</strong>：执行结果</p>

<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line">我是son2子进程！我是son1子进程！
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">我是son3子进程！
</div><div class="hljs-line">主进程结束！
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">Process finished with <span class="hljs-built_in">exit</span> code 0
</div></code></pre>

<hr>



<h4 id="学习引例2">学习引例2</h4>

<p><strong>学习引例（2/2）</strong>：程序</p>

<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line"><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Pool
</div><div class="hljs-line"><span class="hljs-keyword">import</span> time
</div><div class="hljs-line"><span class="hljs-keyword">import</span> os
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">long_time_task</span><span class="hljs-params">(name)</span>:</span>
</div><div class="hljs-line">    print(<span class="hljs-string">'Run task %s (%s)...'</span> % (name, os.getpid()))
</div><div class="hljs-line">    start = time.time()
</div><div class="hljs-line">    time.sleep(<span class="hljs-number">1</span>)
</div><div class="hljs-line">    end = time.time()
</div><div class="hljs-line">    print(<span class="hljs-string">'Task %s runs %0.2f seconds.'</span> % (name, (end - start)))
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
</div><div class="hljs-line">    print(<span class="hljs-string">'Parent process %s.'</span> % os.getpid())
</div><div class="hljs-line">    p = Pool(<span class="hljs-number">5</span>)
</div><div class="hljs-line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):
</div><div class="hljs-line">        p.apply_async(long_time_task, args=(i,))
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    print(<span class="hljs-string">'Waiting for all subprocesses done...'</span>)
</div><div class="hljs-line">    p.close()
</div><div class="hljs-line">    p.join()
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    print(<span class="hljs-string">'All subprocesses done.'</span>)
</div></code></pre>

<p><strong>学习引例（2/2）</strong>：执行结果</p>

<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line">Parent process 7912.
</div><div class="hljs-line">Waiting <span class="hljs-keyword">for</span> all subprocesses done...
</div><div class="hljs-line">Run task 0 (25128)...
</div><div class="hljs-line">Run task 1 (10224)...
</div><div class="hljs-line">Run task 2 (15816)...
</div><div class="hljs-line">Run task 3 (28064)...
</div><div class="hljs-line">Run task 4 (19852)...
</div><div class="hljs-line">Task 0 runs 1.00 seconds.Task 2 runs 1.00 seconds.Task 1 runs 1.00 seconds.
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">Run task 5 (25128)...
</div><div class="hljs-line">Run task 6 (10224)...
</div><div class="hljs-line">Run task 7 (15816)...
</div><div class="hljs-line">Task 4 runs 1.01 seconds.Task 3 runs 1.01 seconds.
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">Run task 8 (28064)...
</div><div class="hljs-line">Run task 9 (19852)...
</div><div class="hljs-line">Task 5 runs 1.01 seconds.
</div><div class="hljs-line">Task 7 runs 1.01 seconds.
</div><div class="hljs-line">Task 6 runs 1.01 seconds.
</div><div class="hljs-line">Task 9 runs 1.01 seconds.Task 8 runs 1.01 seconds.
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">All subprocesses done.
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">Process finished with <span class="hljs-built_in">exit</span> code 0
</div></code></pre>



<h4 id="下面具体应用到我们的程序上">下面具体应用到我们的程序上</h4>

<h5 id="程序11">程序1.1</h5>

<blockquote>
  <ul><li><p>处理col8, col9两个子集。</p></li>
  <li><p>注意关注2个子集的耗时 <br>
  <code>开始时间：2022-08-28 17:26:50</code> <br>
  <code>结束时间：2022-08-28 18:09:18</code> <br>
  <code>总耗时：Time consuming(s): 2547.71</code></p></li>
  <li><p>核心代码强调 <br>
  <code>from multiprocessing import Process</code> <br>
  <code>p = Process(target=filterSentences, args=('col' + post, targetDB, colPackages[i], fields))</code></p></li>
  </ul>
</blockquote>

<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line"><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process  <span class="hljs-comment"># 多进程的类</span>
</div><div class="hljs-line"><span class="hljs-keyword">import</span> time
</div><div class="hljs-line"><span class="hljs-keyword">import</span> pymongo
</div><div class="hljs-line"><span class="hljs-keyword">import</span> jieba
</div><div class="hljs-line"><span class="hljs-keyword">import</span> jieba.analyse  <span class="hljs-comment"># 导入jieba的analyse模块</span>
</div><div class="hljs-line"><span class="hljs-keyword">import</span> jieba.posseg <span class="hljs-keyword">as</span> pseg  <span class="hljs-comment"># 词性标注</span>
</div><div class="hljs-line"><span class="hljs-keyword">import</span> re
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">filterSentences</span><span class="hljs-params">(curCol, targetDB, targetCol, fields)</span>:</span>
</div><div class="hljs-line">    loc = locals()
</div><div class="hljs-line">    db = pymongo.MongoClient(<span class="hljs-string">"localhost:27017"</span>, serverSelectionTimeoutMS=<span class="hljs-number">10000</span>)
</div><div class="hljs-line">    exec(targetDB + <span class="hljs-string">" = db['"</span> + targetDB + <span class="hljs-string">"']"</span>)
</div><div class="hljs-line">    print(targetDB + <span class="hljs-string">": 已连接！"</span>)
</div><div class="hljs-line">    exec(<span class="hljs-string">"colNames = "</span> + targetDB + <span class="hljs-string">".list_collection_names()"</span>)
</div><div class="hljs-line">    print(loc[<span class="hljs-string">'colNames'</span>])
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    print(f<span class="hljs-string">"我是{curCol}子进程！"</span>)
</div><div class="hljs-line">    <span class="hljs-comment"># 提取/过滤（网址、话题、用户名）</span>
</div><div class="hljs-line">    patternLink = re.compile(<span class="hljs-string">r'((http|https|ftp|ftps):\/\/)?([a-zA-Z0-9-]+\.){1,5}(com|cn|net|org|hk|tw)((\/(\w|-)+(\.([a-zA-Z]+))?)+)?(\/)?(\??([\.%:a-zA-Z0-9_-]+=[#\.%:a-zA-Z0-9_-]+(&amp;)?)+)?'</span>)
</div><div class="hljs-line">    patternTopic = re.compile(<span class="hljs-string">r"\#(.+?)\#"</span>)
</div><div class="hljs-line">    patternUsers = re.compile(<span class="hljs-string">r'@([\u4e00-\u9fa5\w\-]+)'</span>)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    exec(targetCol + <span class="hljs-string">" = "</span> + targetDB + <span class="hljs-string">"['"</span> + targetCol + <span class="hljs-string">"']"</span>)
</div><div class="hljs-line">    <span class="hljs-comment"># col_weibo_timePeriod_0 = db_Weibo_SH0331['col_weibo_timePeriod_0']</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    exec(<span class="hljs-string">"recs = "</span> + targetCol + <span class="hljs-string">".find()"</span>)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> loc[<span class="hljs-string">'recs'</span>]:
</div><div class="hljs-line">        id = c[<span class="hljs-string">'_id'</span>]
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        <span class="hljs-comment"># 操作博文主题/内容 ------------------------------</span>
</div><div class="hljs-line">        title = c[<span class="hljs-string">'title8content'</span>]
</div><div class="hljs-line">        <span class="hljs-comment"># 操作博文原始内容 ------------------------------</span>
</div><div class="hljs-line">        orgCon = c[<span class="hljs-string">'orgContent'</span>]
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        plusTxt = title + orgCon
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        plusTxt = re.sub(patternLink, <span class="hljs-string">""</span>, plusTxt) <span class="hljs-comment"># 去除网址</span>
</div><div class="hljs-line">        plusTxt = re.sub(<span class="hljs-string">r"\[(.+?)\]"</span>, <span class="hljs-string">""</span>, plusTxt)  <span class="hljs-comment"># 去除表情</span>
</div><div class="hljs-line">        <span class="hljs-comment"># ================================================================</span>
</div><div class="hljs-line">        words = pseg.cut(plusTxt)
</div><div class="hljs-line">        personsName_preDup = list()
</div><div class="hljs-line">        placesName_preDup = list()
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        <span class="hljs-keyword">for</span> word, flag <span class="hljs-keyword">in</span> words:
</div><div class="hljs-line">            <span class="hljs-keyword">if</span>(flag == <span class="hljs-string">'nr'</span>):
</div><div class="hljs-line">                personsName_preDup.append(word)
</div><div class="hljs-line">            <span class="hljs-keyword">if</span>(flag == <span class="hljs-string">'ns'</span>):
</div><div class="hljs-line">                placesName_preDup.append(word)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        personsName = list(set(personsName_preDup))
</div><div class="hljs-line">        placesName = list(set(placesName_preDup))
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        <span class="hljs-comment"># ---------------------------------------------------------------</span>
</div><div class="hljs-line">        <span class="hljs-comment"># personsName = jieba.analyse.extract_tags(plusTxt,allowPOS=('nr',))  # ●</span>
</div><div class="hljs-line">        <span class="hljs-comment"># placesName = jieba.analyse.extract_tags(plusTxt,allowPOS=('ns',))  # ●</span>
</div><div class="hljs-line">        <span class="hljs-comment"># ================================================================</span>
</div><div class="hljs-line">        resTopic = patternTopic.findall(plusTxt)  <span class="hljs-comment"># 提取plusTxt中的话题 # ●</span>
</div><div class="hljs-line">        <span class="hljs-comment"># plusTxt = re.sub(patternTopic, "", plusTxt)  # 删除plusTxt中的话题</span>
</div><div class="hljs-line">        resUsers = patternUsers.findall(plusTxt)  <span class="hljs-comment"># 提取plusTxt中的用户 # ●</span>
</div><div class="hljs-line">        <span class="hljs-comment"># plusTxt = re.sub(patternUsers, "", plusTxt)  # 删除plusTxt中的用户</span>
</div><div class="hljs-line">        kWords = jieba.analyse.extract_tags(plusTxt) <span class="hljs-comment"># ●</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        f1 = fields[<span class="hljs-number">0</span>]  <span class="hljs-comment"># personsName</span>
</div><div class="hljs-line">        f2 = fields[<span class="hljs-number">1</span>]  <span class="hljs-comment"># placesName</span>
</div><div class="hljs-line">        f3 = fields[<span class="hljs-number">2</span>]  <span class="hljs-comment"># resTopic</span>
</div><div class="hljs-line">        f4 = fields[<span class="hljs-number">3</span>]  <span class="hljs-comment"># resUsers</span>
</div><div class="hljs-line">        f5 = fields[<span class="hljs-number">4</span>]  <span class="hljs-comment"># kWords</span>
</div><div class="hljs-line">        <span class="hljs-comment"># 5 in 1</span>
</div><div class="hljs-line">        exec(targetCol + <span class="hljs-string">".update_one({'_id': id}, {'$set': {'"</span> + f1 + <span class="hljs-string">"': personsName, '"</span> + f2 + <span class="hljs-string">"': placesName, '"</span> + f3 + <span class="hljs-string">"': resTopic, '"</span> + f4 + <span class="hljs-string">"': resUsers, '"</span> + f5 + <span class="hljs-string">"': kWords}})"</span>)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    targetDB = <span class="hljs-string">'db_Weibo_SH0331'</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    startTime = time.time()
</div><div class="hljs-line">    print(time.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>, time.localtime(startTime)))
</div><div class="hljs-line">    <span class="hljs-comment"># 开始处理----↓</span>
</div><div class="hljs-line">    patternNum = <span class="hljs-string">'[0-9]+'</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    <span class="hljs-comment"># 循环处理24个集合</span>
</div><div class="hljs-line">    subCol24 = list()
</div><div class="hljs-line">    subCol24.append([<span class="hljs-string">"col_weibo_timePeriod_"</span> + str(period) <span class="hljs-keyword">for</span> period <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>, <span class="hljs-number">10</span>)])
</div><div class="hljs-line">    colPackages = subCol24[<span class="hljs-number">0</span>]
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    fields = [<span class="hljs-string">'personsName'</span>, <span class="hljs-string">'placesName'</span>, <span class="hljs-string">'resTopic'</span>, <span class="hljs-string">'resUsers'</span>, <span class="hljs-string">'kWords'</span>]
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    process_list = []    <span class="hljs-comment"># 存放开启的进程</span>
</div><div class="hljs-line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(colPackages)):
</div><div class="hljs-line">        post = re.search(patternNum, colPackages[i]).group()
</div><div class="hljs-line">        <span class="hljs-comment"># 进程中的参数args表示调用对象的位置参数元组.注意：元组中只有一个元素时结尾要加","逗号</span>
</div><div class="hljs-line">        p = Process(target=filterSentences, args=(<span class="hljs-string">'col'</span> + post, targetDB, colPackages[i], fields))
</div><div class="hljs-line">        p.start()
</div><div class="hljs-line">        print(<span class="hljs-string">'------&gt; Thread id : %d'</span> % p.ident)  <span class="hljs-comment"># 进程id</span>
</div><div class="hljs-line">        print(<span class="hljs-string">'------&gt; Thread name : %s'</span> % p.name)  <span class="hljs-comment"># 进程name</span>
</div><div class="hljs-line">        process_list.append(p)
</div><div class="hljs-line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> process_list:
</div><div class="hljs-line">        i.join()    <span class="hljs-comment"># 阻塞每个子进程，主进程会等待所有子进程结束再结束主进程</span>
</div><div class="hljs-line">    print(<span class="hljs-string">"主进程结束！"</span>)
</div><div class="hljs-line">    <span class="hljs-comment"># 结束处理----↑</span>
</div><div class="hljs-line">    endTime = time.time()
</div><div class="hljs-line">    print(time.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>, time.localtime(endTime)))
</div><div class="hljs-line">    print(<span class="hljs-string">"Time consuming(s): %.2f"</span> % (endTime - startTime))
</div></code></pre>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line">2022-08-28 17:26:50
</div><div class="hljs-line">------&gt; Thread id : 4100
</div><div class="hljs-line">------&gt; Thread name : Process-1
</div><div class="hljs-line">------&gt; Thread id : 20548
</div><div class="hljs-line">------&gt; Thread name : Process-2
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">[<span class="hljs-string">'col_weibo_timePeriod_16'</span>, <span class="hljs-string">'col_weibo_timePeriod_23'</span>, <span class="hljs-string">'col_weibo_timePeriod_17'</span>, <span class="hljs-string">'col_weibo_timePeriod_9'</span>, <span class="hljs-string">'col_weibo_timePeriod_18'</span>, <span class="hljs-string">'col_weibo_timePeriod_15'</span>, <span class="hljs-string">'col_weibo_timePeriod_1'</span>, <span class="hljs-string">'col_weibo_timePeriod_13'</span>, <span class="hljs-string">'col_weibo_timePeriod_3'</span>, <span class="hljs-string">'col_Weibo_SH0331'</span>, <span class="hljs-string">'col_weibo_timePeriod_21'</span>, <span class="hljs-string">'col_weibo_timePeriod_14'</span>, <span class="hljs-string">'col_weibo_timePeriod_20'</span>, <span class="hljs-string">'col_weibo_timePeriod_12'</span>, <span class="hljs-string">'col_weibo_timePeriod_10'</span>, <span class="hljs-string">'col_weibo_timePeriod_22'</span>, <span class="hljs-string">'col_weibo_timePeriod_4'</span>, <span class="hljs-string">'col_weibo_timePeriod_7'</span>, <span class="hljs-string">'col_weibo_timePeriod_19'</span>, <span class="hljs-string">'col_weibo_timePeriod_8'</span>, <span class="hljs-string">'col_weibo_timePeriod_5'</span>, <span class="hljs-string">'col_weibo_timePeriod_2'</span>, <span class="hljs-string">'col_weibo_timePeriod_6'</span>, <span class="hljs-string">'col_weibo_timePeriod_0'</span>, <span class="hljs-string">'col_weibo_timePeriod_11'</span>]
</div><div class="hljs-line">我是col8子进程！
</div><div class="hljs-line">Building prefix dict from the default dictionary ...
</div><div class="hljs-line">Loading model from cache C:\Users\t\AppData\Local\Temp\jieba.cache
</div><div class="hljs-line">[<span class="hljs-string">'col_weibo_timePeriod_16'</span>, <span class="hljs-string">'col_weibo_timePeriod_23'</span>, <span class="hljs-string">'col_weibo_timePeriod_17'</span>, <span class="hljs-string">'col_weibo_timePeriod_9'</span>, <span class="hljs-string">'col_weibo_timePeriod_18'</span>, <span class="hljs-string">'col_weibo_timePeriod_15'</span>, <span class="hljs-string">'col_weibo_timePeriod_1'</span>, <span class="hljs-string">'col_weibo_timePeriod_13'</span>, <span class="hljs-string">'col_weibo_timePeriod_3'</span>, <span class="hljs-string">'col_Weibo_SH0331'</span>, <span class="hljs-string">'col_weibo_timePeriod_21'</span>, <span class="hljs-string">'col_weibo_timePeriod_14'</span>, <span class="hljs-string">'col_weibo_timePeriod_20'</span>, <span class="hljs-string">'col_weibo_timePeriod_12'</span>, <span class="hljs-string">'col_weibo_timePeriod_10'</span>, <span class="hljs-string">'col_weibo_timePeriod_22'</span>, <span class="hljs-string">'col_weibo_timePeriod_4'</span>, <span class="hljs-string">'col_weibo_timePeriod_7'</span>, <span class="hljs-string">'col_weibo_timePeriod_19'</span>, <span class="hljs-string">'col_weibo_timePeriod_8'</span>, <span class="hljs-string">'col_weibo_timePeriod_5'</span>, <span class="hljs-string">'col_weibo_timePeriod_2'</span>, <span class="hljs-string">'col_weibo_timePeriod_6'</span>, <span class="hljs-string">'col_weibo_timePeriod_0'</span>, <span class="hljs-string">'col_weibo_timePeriod_11'</span>]
</div><div class="hljs-line">我是col9子进程！
</div><div class="hljs-line">Building prefix dict from the default dictionary ...
</div><div class="hljs-line">Loading model from cache C:\Users\t\AppData\Local\Temp\jieba.cache
</div><div class="hljs-line">Loading model cost 0.840 seconds.
</div><div class="hljs-line">Prefix dict has been built successfully.
</div><div class="hljs-line">Loading model cost 0.825 seconds.
</div><div class="hljs-line">Prefix dict has been built successfully.
</div><div class="hljs-line">主进程结束！
</div><div class="hljs-line">2022-08-28 18:09:18
</div><div class="hljs-line">Time consuming(s): 2547.71
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">Process finished with <span class="hljs-built_in">exit</span> code 0
</div><div class="hljs-line"><wbr>
</div></code></pre>

<blockquote>
  <p><strong>多进程&amp;多线程注意要点</strong>：</p>
  
  <ol><li rel="1"><p><code>multiprocessing</code>模块不支持交互模式，所以多进程的代码在<code>jupyter notebook</code>中无法运行——<code>jupyter</code>只能跟踪主进程，没法跟踪子进程。<em>必须在 cmd 里头输入 python xxx.py 来运行，才可以看到子进程的执行。</em></p></li>
  <li rel="2"><p>python的多线程无法有效利用CPU，例如本文执行的程序，不管开多少个线程，单个python进程对应的CPU占用，一直都是12%上下。而此时我换成了多进程（上述代码是2个进程），python进程对应的CPU占用是24%，i.e., python多进程可以充分利用CPU。<code>-_-怪不得我一直跑啊跑，就是不见速度上来。</code></p></li>
  </ol>
</blockquote>

<h5 id="程序12">程序1.2</h5>

<blockquote>
  <ul><li><p>处理col10这1个子集。</p></li>
  <li><p>注意关注1个子集的耗时 <br>
  <code>开始时间：2022-08-28 18:16:34</code> <br>
  <code>结束时间：2022-08-28 18:40:36</code> <br>
  <code>总耗时：Time consuming(s): 1442.52</code></p></li>
  <li><p>核心代码强调 <br>
  <code>from multiprocessing import Process</code> <br>
  <code>p = Process(target=filterSentences, args=('col' + post, targetDB, colPackages[i], fields))</code></p></li>
  </ul>
</blockquote>

<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line">2022-08-28 18:16:34
</div><div class="hljs-line">------&gt; Thread id : 20448
</div><div class="hljs-line">------&gt; Thread name : Process-1
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">[<span class="hljs-string">'col_weibo_timePeriod_16'</span>, <span class="hljs-string">'col_weibo_timePeriod_23'</span>, <span class="hljs-string">'col_weibo_timePeriod_17'</span>, <span class="hljs-string">'col_weibo_timePeriod_9'</span>, <span class="hljs-string">'col_weibo_timePeriod_18'</span>, <span class="hljs-string">'col_weibo_timePeriod_15'</span>, <span class="hljs-string">'col_weibo_timePeriod_1'</span>, <span class="hljs-string">'col_weibo_timePeriod_13'</span>, <span class="hljs-string">'col_weibo_timePeriod_3'</span>, <span class="hljs-string">'col_Weibo_SH0331'</span>, <span class="hljs-string">'col_weibo_timePeriod_21'</span>, <span class="hljs-string">'col_weibo_timePeriod_14'</span>, <span class="hljs-string">'col_weibo_timePeriod_20'</span>, <span class="hljs-string">'col_weibo_timePeriod_12'</span>, <span class="hljs-string">'col_weibo_timePeriod_10'</span>, <span class="hljs-string">'col_weibo_timePeriod_22'</span>, <span class="hljs-string">'col_weibo_timePeriod_4'</span>, <span class="hljs-string">'col_weibo_timePeriod_7'</span>, <span class="hljs-string">'col_weibo_timePeriod_19'</span>, <span class="hljs-string">'col_weibo_timePeriod_8'</span>, <span class="hljs-string">'col_weibo_timePeriod_5'</span>, <span class="hljs-string">'col_weibo_timePeriod_2'</span>, <span class="hljs-string">'col_weibo_timePeriod_6'</span>, <span class="hljs-string">'col_weibo_timePeriod_0'</span>, <span class="hljs-string">'col_weibo_timePeriod_11'</span>]
</div><div class="hljs-line">我是col10子进程！
</div><div class="hljs-line">Building prefix dict from the default dictionary ...
</div><div class="hljs-line">Loading model from cache C:\Users\t\AppData\Local\Temp\jieba.cache
</div><div class="hljs-line">Loading model cost 0.705 seconds.
</div><div class="hljs-line">Prefix dict has been built successfully.
</div><div class="hljs-line">主进程结束！
</div><div class="hljs-line">2022-08-28 18:40:36
</div><div class="hljs-line">Time consuming(s): 1442.52
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">Process finished with <span class="hljs-built_in">exit</span> code 0
</div></code></pre>



<h5 id="程序13">程序1.3</h5>

<blockquote>
  <ul><li><p>处理col11, col12, col13, col14这4个子集。</p></li>
  <li><p>注意关注4个子集的耗时 <br>
  <code>开始时间：2022-08-28 18:43:56</code> <br>
  <code>结束时间：2022-08-28 19:21:07</code> <br>
  <code>总耗时：Time consuming(s): 2230.58</code></p></li>
  <li><p>核心代码强调 <br>
  <code>from multiprocessing import Process</code> <br>
  <code>p = Process(target=filterSentences, args=('col' + post, targetDB, colPackages[i], fields))</code></p></li>
  </ul>
</blockquote>

<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line">2022-08-28 18:43:56
</div><div class="hljs-line">------&gt; Thread id : 3352
</div><div class="hljs-line">------&gt; Thread name : Process-1
</div><div class="hljs-line">------&gt; Thread id : 6220
</div><div class="hljs-line">------&gt; Thread name : Process-2
</div><div class="hljs-line">------&gt; Thread id : 5580
</div><div class="hljs-line">------&gt; Thread name : Process-3
</div><div class="hljs-line">------&gt; Thread id : 10076
</div><div class="hljs-line">------&gt; Thread name : Process-4
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！db_Weibo_SH0331: 已连接！
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">[<span class="hljs-string">'col_weibo_timePeriod_16'</span>, <span class="hljs-string">'col_weibo_timePeriod_23'</span>, <span class="hljs-string">'col_weibo_timePeriod_17'</span>, <span class="hljs-string">'col_weibo_timePeriod_9'</span>, <span class="hljs-string">'col_weibo_timePeriod_18'</span>, <span class="hljs-string">'col_weibo_timePeriod_15'</span>, <span class="hljs-string">'col_weibo_timePeriod_1'</span>, <span class="hljs-string">'col_weibo_timePeriod_13'</span>, <span class="hljs-string">'col_weibo_timePeriod_3'</span>, <span class="hljs-string">'col_Weibo_SH0331'</span>, <span class="hljs-string">'col_weibo_timePeriod_21'</span>, <span class="hljs-string">'col_weibo_timePeriod_14'</span>, <span class="hljs-string">'col_weibo_timePeriod_20'</span>, <span class="hljs-string">'col_weibo_timePeriod_12'</span>, <span class="hljs-string">'col_weibo_timePeriod_10'</span>, <span class="hljs-string">'col_weibo_timePeriod_22'</span>, <span class="hljs-string">'col_weibo_timePeriod_4'</span>, <span class="hljs-string">'col_weibo_timePeriod_7'</span>, <span class="hljs-string">'col_weibo_timePeriod_19'</span>, <span class="hljs-string">'col_weibo_timePeriod_8'</span>, <span class="hljs-string">'col_weibo_timePeriod_5'</span>, <span class="hljs-string">'col_weibo_timePeriod_2'</span>, <span class="hljs-string">'col_weibo_timePeriod_6'</span>, <span class="hljs-string">'col_weibo_timePeriod_0'</span>, <span class="hljs-string">'col_weibo_timePeriod_11'</span>]
</div><div class="hljs-line">我是col14子进程！
</div><div class="hljs-line">[<span class="hljs-string">'col_weibo_timePeriod_16'</span>, <span class="hljs-string">'col_weibo_timePeriod_23'</span>, <span class="hljs-string">'col_weibo_timePeriod_17'</span>, <span class="hljs-string">'col_weibo_timePeriod_9'</span>, <span class="hljs-string">'col_weibo_timePeriod_18'</span>, <span class="hljs-string">'col_weibo_timePeriod_15'</span>, <span class="hljs-string">'col_weibo_timePeriod_1'</span>, <span class="hljs-string">'col_weibo_timePeriod_13'</span>, <span class="hljs-string">'col_weibo_timePeriod_3'</span>, <span class="hljs-string">'col_Weibo_SH0331'</span>, <span class="hljs-string">'col_weibo_timePeriod_21'</span>, <span class="hljs-string">'col_weibo_timePeriod_14'</span>, <span class="hljs-string">'col_weibo_timePeriod_20'</span>, <span class="hljs-string">'col_weibo_timePeriod_12'</span>, <span class="hljs-string">'col_weibo_timePeriod_10'</span>, <span class="hljs-string">'col_weibo_timePeriod_22'</span>, <span class="hljs-string">'col_weibo_timePeriod_4'</span>, <span class="hljs-string">'col_weibo_timePeriod_7'</span>, <span class="hljs-string">'col_weibo_timePeriod_19'</span>, <span class="hljs-string">'col_weibo_timePeriod_8'</span>, <span class="hljs-string">'col_weibo_timePeriod_5'</span>, <span class="hljs-string">'col_weibo_timePeriod_2'</span>, <span class="hljs-string">'col_weibo_timePeriod_6'</span>, <span class="hljs-string">'col_weibo_timePeriod_0'</span>, <span class="hljs-string">'col_weibo_timePeriod_11'</span>]
</div><div class="hljs-line">我是col13子进程！
</div><div class="hljs-line">[<span class="hljs-string">'col_weibo_timePeriod_16'</span>, <span class="hljs-string">'col_weibo_timePeriod_23'</span>, <span class="hljs-string">'col_weibo_timePeriod_17'</span>, <span class="hljs-string">'col_weibo_timePeriod_9'</span>, <span class="hljs-string">'col_weibo_timePeriod_18'</span>, <span class="hljs-string">'col_weibo_timePeriod_15'</span>, <span class="hljs-string">'col_weibo_timePeriod_1'</span>, <span class="hljs-string">'col_weibo_timePeriod_13'</span>, <span class="hljs-string">'col_weibo_timePeriod_3'</span>, <span class="hljs-string">'col_Weibo_SH0331'</span>, <span class="hljs-string">'col_weibo_timePeriod_21'</span>, <span class="hljs-string">'col_weibo_timePeriod_14'</span>, <span class="hljs-string">'col_weibo_timePeriod_20'</span>, <span class="hljs-string">'col_weibo_timePeriod_12'</span>, <span class="hljs-string">'col_weibo_timePeriod_10'</span>, <span class="hljs-string">'col_weibo_timePeriod_22'</span>, <span class="hljs-string">'col_weibo_timePeriod_4'</span>, <span class="hljs-string">'col_weibo_timePeriod_7'</span>, <span class="hljs-string">'col_weibo_timePeriod_19'</span>, <span class="hljs-string">'col_weibo_timePeriod_8'</span>, <span class="hljs-string">'col_weibo_timePeriod_5'</span>, <span class="hljs-string">'col_weibo_timePeriod_2'</span>, <span class="hljs-string">'col_weibo_timePeriod_6'</span>, <span class="hljs-string">'col_weibo_timePeriod_0'</span>, <span class="hljs-string">'col_weibo_timePeriod_11'</span>]
</div><div class="hljs-line">我是col11子进程！
</div><div class="hljs-line">[<span class="hljs-string">'col_weibo_timePeriod_16'</span>, <span class="hljs-string">'col_weibo_timePeriod_23'</span>, <span class="hljs-string">'col_weibo_timePeriod_17'</span>, <span class="hljs-string">'col_weibo_timePeriod_9'</span>, <span class="hljs-string">'col_weibo_timePeriod_18'</span>, <span class="hljs-string">'col_weibo_timePeriod_15'</span>, <span class="hljs-string">'col_weibo_timePeriod_1'</span>, <span class="hljs-string">'col_weibo_timePeriod_13'</span>, <span class="hljs-string">'col_weibo_timePeriod_3'</span>, <span class="hljs-string">'col_Weibo_SH0331'</span>, <span class="hljs-string">'col_weibo_timePeriod_21'</span>, <span class="hljs-string">'col_weibo_timePeriod_14'</span>, <span class="hljs-string">'col_weibo_timePeriod_20'</span>, <span class="hljs-string">'col_weibo_timePeriod_12'</span>, <span class="hljs-string">'col_weibo_timePeriod_10'</span>, <span class="hljs-string">'col_weibo_timePeriod_22'</span>, <span class="hljs-string">'col_weibo_timePeriod_4'</span>, <span class="hljs-string">'col_weibo_timePeriod_7'</span>, <span class="hljs-string">'col_weibo_timePeriod_19'</span>, <span class="hljs-string">'col_weibo_timePeriod_8'</span>, <span class="hljs-string">'col_weibo_timePeriod_5'</span>, <span class="hljs-string">'col_weibo_timePeriod_2'</span>, <span class="hljs-string">'col_weibo_timePeriod_6'</span>, <span class="hljs-string">'col_weibo_timePeriod_0'</span>, <span class="hljs-string">'col_weibo_timePeriod_11'</span>]
</div><div class="hljs-line">我是col12子进程！
</div><div class="hljs-line">Building prefix dict from the default dictionary ...
</div><div class="hljs-line">Loading model from cache C:\Users\t\AppData\Local\Temp\jieba.cache
</div><div class="hljs-line">Building prefix dict from the default dictionary ...
</div><div class="hljs-line">Building prefix dict from the default dictionary ...
</div><div class="hljs-line">Building prefix dict from the default dictionary ...
</div><div class="hljs-line">Loading model from cache C:\Users\t\AppData\Local\Temp\jieba.cache
</div><div class="hljs-line">Loading model from cache C:\Users\t\AppData\Local\Temp\jieba.cache
</div><div class="hljs-line">Loading model from cache C:\Users\t\AppData\Local\Temp\jieba.cache
</div><div class="hljs-line">Loading model cost 0.958 seconds.
</div><div class="hljs-line">Prefix dict has been built successfully.
</div><div class="hljs-line">Loading model cost 0.966 seconds.
</div><div class="hljs-line">Prefix dict has been built successfully.
</div><div class="hljs-line">Loading model cost 0.974 seconds.
</div><div class="hljs-line">Prefix dict has been built successfully.
</div><div class="hljs-line">Loading model cost 1.028 seconds.
</div><div class="hljs-line">Prefix dict has been built successfully.
</div><div class="hljs-line">主进程结束！
</div><div class="hljs-line">2022-08-28 19:21:07
</div><div class="hljs-line">Time consuming(s): 2230.58
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">Process finished with <span class="hljs-built_in">exit</span> code 0
</div></code></pre>

<h5 id="程序2">程序2</h5>

<blockquote>
  <p>与程序1不同的是用了<code>进程池（Pool）</code>。设置好池内进程数n，一次处理n个程序，如果提前有某个程序结束了，就再入池1个，继续执行直至主程序结束。</p>
  
  <ul><li><p>处理col15 ~ col23这9个子集。</p></li>
  <li><p>注意关注9个子集的耗时 <br>
  <code>开始时间：2022-08-28 19:31:55</code> <br>
  <code>结束时间：2022-08-28 20:25:37</code> <br>
  <code>总耗时：Time consuming(s): 3221.97</code></p></li>
  <li><p>核心代码强调 <br>
  <code>from multiprocessing import Pool</code> <br>
  <code>p.apply_async(filterSentences, args=('col' + post, targetDB, colPackages[i], fields))</code></p></li>
  </ul>
</blockquote>

<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line"><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Pool
</div><div class="hljs-line"><span class="hljs-keyword">import</span> time
</div><div class="hljs-line"><span class="hljs-keyword">import</span> pymongo
</div><div class="hljs-line"><span class="hljs-keyword">import</span> jieba
</div><div class="hljs-line"><span class="hljs-keyword">import</span> jieba.analyse  <span class="hljs-comment"># 导入jieba的analyse模块</span>
</div><div class="hljs-line"><span class="hljs-keyword">import</span> jieba.posseg <span class="hljs-keyword">as</span> pseg  <span class="hljs-comment"># 词性标注</span>
</div><div class="hljs-line"><span class="hljs-keyword">import</span> re
</div><div class="hljs-line"><span class="hljs-keyword">import</span> os
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">filterSentences</span><span class="hljs-params">(curCol, targetDB, targetCol, fields)</span>:</span>
</div><div class="hljs-line">    loc = locals()
</div><div class="hljs-line">    db = pymongo.MongoClient(<span class="hljs-string">"localhost:27017"</span>, serverSelectionTimeoutMS=<span class="hljs-number">10000</span>)
</div><div class="hljs-line">    exec(targetDB + <span class="hljs-string">" = db['"</span> + targetDB + <span class="hljs-string">"']"</span>)
</div><div class="hljs-line">    print(targetDB + <span class="hljs-string">": 已连接！"</span>)
</div><div class="hljs-line">    <span class="hljs-comment"># exec("colNames = " + targetDB + ".list_collection_names()")</span>
</div><div class="hljs-line">    <span class="hljs-comment"># print(loc['colNames'])</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    print(f<span class="hljs-string">"我是{curCol}子进程，我的进程号为{os.getpid()}，我开始执行了..."</span>)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    <span class="hljs-comment"># 提取/过滤（网址、话题、用户名）</span>
</div><div class="hljs-line">    patternLink = re.compile(<span class="hljs-string">r'((http|https|ftp|ftps):\/\/)?([a-zA-Z0-9-]+\.){1,5}(com|cn|net|org|hk|tw)((\/(\w|-)+(\.([a-zA-Z]+))?)+)?(\/)?(\??([\.%:a-zA-Z0-9_-]+=[#\.%:a-zA-Z0-9_-]+(&amp;)?)+)?'</span>)
</div><div class="hljs-line">    patternTopic = re.compile(<span class="hljs-string">r"\#(.+?)\#"</span>)
</div><div class="hljs-line">    patternUsers = re.compile(<span class="hljs-string">r'@([\u4e00-\u9fa5\w\-]+)'</span>)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    exec(targetCol + <span class="hljs-string">" = "</span> + targetDB + <span class="hljs-string">"['"</span> + targetCol + <span class="hljs-string">"']"</span>)
</div><div class="hljs-line">    <span class="hljs-comment"># col_weibo_timePeriod_0 = db_Weibo_SH0331['col_weibo_timePeriod_0']</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    exec(<span class="hljs-string">"recs = "</span> + targetCol + <span class="hljs-string">".find()"</span>)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> loc[<span class="hljs-string">'recs'</span>]:
</div><div class="hljs-line">        id = c[<span class="hljs-string">'_id'</span>]
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        <span class="hljs-comment"># 操作博文主题/内容 ------------------------------</span>
</div><div class="hljs-line">        title = c[<span class="hljs-string">'title8content'</span>]
</div><div class="hljs-line">        <span class="hljs-comment"># 操作博文原始内容 ------------------------------</span>
</div><div class="hljs-line">        orgCon = c[<span class="hljs-string">'orgContent'</span>]
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        plusTxt = title + orgCon
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        plusTxt = re.sub(patternLink, <span class="hljs-string">""</span>, plusTxt) <span class="hljs-comment"># 去除网址</span>
</div><div class="hljs-line">        plusTxt = re.sub(<span class="hljs-string">r"\[(.+?)\]"</span>, <span class="hljs-string">""</span>, plusTxt)  <span class="hljs-comment"># 去除表情</span>
</div><div class="hljs-line">        <span class="hljs-comment"># ================================================================</span>
</div><div class="hljs-line">        words = pseg.cut(plusTxt)
</div><div class="hljs-line">        personsName_preDup = list()
</div><div class="hljs-line">        placesName_preDup = list()
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        <span class="hljs-keyword">for</span> word, flag <span class="hljs-keyword">in</span> words:
</div><div class="hljs-line">            <span class="hljs-keyword">if</span>(flag == <span class="hljs-string">'nr'</span>):
</div><div class="hljs-line">                personsName_preDup.append(word)
</div><div class="hljs-line">            <span class="hljs-keyword">if</span>(flag == <span class="hljs-string">'ns'</span>):
</div><div class="hljs-line">                placesName_preDup.append(word)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        personsName = list(set(personsName_preDup))
</div><div class="hljs-line">        placesName = list(set(placesName_preDup))
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        <span class="hljs-comment"># ---------------------------------------------------------------</span>
</div><div class="hljs-line">        <span class="hljs-comment"># personsName = jieba.analyse.extract_tags(plusTxt,allowPOS=('nr',))  # ●</span>
</div><div class="hljs-line">        <span class="hljs-comment"># placesName = jieba.analyse.extract_tags(plusTxt,allowPOS=('ns',))  # ●</span>
</div><div class="hljs-line">        <span class="hljs-comment"># ================================================================</span>
</div><div class="hljs-line">        resTopic = patternTopic.findall(plusTxt)  <span class="hljs-comment"># 提取plusTxt中的话题 # ●</span>
</div><div class="hljs-line">        <span class="hljs-comment"># plusTxt = re.sub(patternTopic, "", plusTxt)  # 删除plusTxt中的话题</span>
</div><div class="hljs-line">        resUsers = patternUsers.findall(plusTxt)  <span class="hljs-comment"># 提取plusTxt中的用户 # ●</span>
</div><div class="hljs-line">        <span class="hljs-comment"># plusTxt = re.sub(patternUsers, "", plusTxt)  # 删除plusTxt中的用户</span>
</div><div class="hljs-line">        kWords = jieba.analyse.extract_tags(plusTxt) <span class="hljs-comment"># ●</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">        f1 = fields[<span class="hljs-number">0</span>]  <span class="hljs-comment"># personsName</span>
</div><div class="hljs-line">        f2 = fields[<span class="hljs-number">1</span>]  <span class="hljs-comment"># placesName</span>
</div><div class="hljs-line">        f3 = fields[<span class="hljs-number">2</span>]  <span class="hljs-comment"># resTopic</span>
</div><div class="hljs-line">        f4 = fields[<span class="hljs-number">3</span>]  <span class="hljs-comment"># resUsers</span>
</div><div class="hljs-line">        f5 = fields[<span class="hljs-number">4</span>]  <span class="hljs-comment"># kWords</span>
</div><div class="hljs-line">        <span class="hljs-comment"># 5 in 1</span>
</div><div class="hljs-line">        exec(targetCol + <span class="hljs-string">".update_one({'_id': id}, {'$set': {'"</span> + f1 + <span class="hljs-string">"': personsName, '"</span> + f2 + <span class="hljs-string">"': placesName, '"</span> + f3 + <span class="hljs-string">"': resTopic, '"</span> + f4 + <span class="hljs-string">"': resUsers, '"</span> + f5 + <span class="hljs-string">"': kWords}})"</span>)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    print(f<span class="hljs-string">"我是{curCol}子进程，我执行完了！"</span>)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
</div><div class="hljs-line">    targetDB = <span class="hljs-string">'db_Weibo_SH0331'</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    startTime = time.time()
</div><div class="hljs-line">    print(time.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>, time.localtime(startTime)))
</div><div class="hljs-line">    <span class="hljs-comment"># 开始处理----↓</span>
</div><div class="hljs-line">    patternNum = <span class="hljs-string">'[0-9]+'</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    <span class="hljs-comment"># 循环处理24个集合</span>
</div><div class="hljs-line">    subCol24 = list()
</div><div class="hljs-line">    subCol24.append([<span class="hljs-string">"col_weibo_timePeriod_"</span> + str(period) <span class="hljs-keyword">for</span> period <span class="hljs-keyword">in</span> range(<span class="hljs-number">15</span>, <span class="hljs-number">24</span>)])
</div><div class="hljs-line">    colPackages = subCol24[<span class="hljs-number">0</span>]
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    fields = [<span class="hljs-string">'personsName'</span>, <span class="hljs-string">'placesName'</span>, <span class="hljs-string">'resTopic'</span>, <span class="hljs-string">'resUsers'</span>, <span class="hljs-string">'kWords'</span>]
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    p = Pool(<span class="hljs-number">4</span>)
</div><div class="hljs-line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(colPackages)):
</div><div class="hljs-line">        post = re.search(patternNum, colPackages[i]).group()
</div><div class="hljs-line">        p.apply_async(filterSentences, args=(<span class="hljs-string">'col'</span> + post, targetDB, colPackages[i], fields))
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    print(<span class="hljs-string">'Waiting for all subprocesses done...'</span>)
</div><div class="hljs-line">    p.close()
</div><div class="hljs-line">    p.join()
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    <span class="hljs-string">'''</span>
</div><div class="hljs-line"><span class="hljs-string">    process_list = []    # 存放开启的进程</span>
</div><div class="hljs-line"><span class="hljs-string">    for i in range(0, len(colPackages)):</span>
</div><div class="hljs-line"><span class="hljs-string">        post = re.search(patternNum, colPackages[i]).group()</span>
</div><div class="hljs-line"><span class="hljs-string">        # 进程中的参数args表示调用对象的位置参数元组.注意：元组中只有一个元素时结尾要加","逗号</span>
</div><div class="hljs-line"><span class="hljs-string">        p = Process(target=filterSentences, args=('col' + post, targetDB, colPackages[i], fields))</span>
</div><div class="hljs-line"><span class="hljs-string">        p.start()</span>
</div><div class="hljs-line"><span class="hljs-string">        print('------&gt; Thread id : %d' % p.ident)  # 进程id</span>
</div><div class="hljs-line"><span class="hljs-string">        print('------&gt; Thread name : %s' % p.name)  # 进程name</span>
</div><div class="hljs-line"><span class="hljs-string">        process_list.append(p)</span>
</div><div class="hljs-line"><span class="hljs-string">    for i in process_list:</span>
</div><div class="hljs-line"><span class="hljs-string">        i.join()    # 阻塞每个子进程，主进程会等待所有子进程结束再结束主进程</span>
</div><div class="hljs-line"><span class="hljs-string">    '''</span>
</div><div class="hljs-line">    print(<span class="hljs-string">"主进程结束！"</span>)
</div><div class="hljs-line">    <span class="hljs-comment"># 结束处理----↑</span>
</div><div class="hljs-line">    endTime = time.time()
</div><div class="hljs-line">    print(time.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>, time.localtime(endTime)))
</div><div class="hljs-line">    print(<span class="hljs-string">"Time consuming(s): %.2f"</span> % (endTime - startTime))
</div></code></pre>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line"><wbr>
</div><div class="hljs-line">2022-08-28 19:31:55
</div><div class="hljs-line">Waiting <span class="hljs-keyword">for</span> all subprocesses done...
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">我是col15子进程，我的进程号为21764，我开始执行了...
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！我是col18子进程，我的进程号为11788，我开始执行了...
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">我是col17子进程，我的进程号为2264，我开始执行了...
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">我是col16子进程，我的进程号为21708，我开始执行了...
</div><div class="hljs-line">Building prefix dict from the default dictionary ...
</div><div class="hljs-line">Loading model from cache C:\Users\t\AppData\Local\Temp\jieba.cache
</div><div class="hljs-line">Building prefix dict from the default dictionary ...
</div><div class="hljs-line">Building prefix dict from the default dictionary ...
</div><div class="hljs-line">Loading model from cache C:\Users\t\AppData\Local\Temp\jieba.cache
</div><div class="hljs-line">Loading model from cache C:\Users\t\AppData\Local\Temp\jieba.cache
</div><div class="hljs-line">Building prefix dict from the default dictionary ...
</div><div class="hljs-line">Loading model from cache C:\Users\t\AppData\Local\Temp\jieba.cache
</div><div class="hljs-line">Loading model cost 1.599 seconds.
</div><div class="hljs-line">Prefix dict has been built successfully.
</div><div class="hljs-line">Loading model cost 1.608 seconds.
</div><div class="hljs-line">Prefix dict has been built successfully.
</div><div class="hljs-line">Loading model cost 1.625 seconds.
</div><div class="hljs-line">Prefix dict has been built successfully.
</div><div class="hljs-line">Loading model cost 1.645 seconds.
</div><div class="hljs-line">Prefix dict has been built successfully.
</div><div class="hljs-line">我是col18子进程，我执行完了！
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">我是col19子进程，我的进程号为11788，我开始执行了...
</div><div class="hljs-line">我是col17子进程，我执行完了！
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">我是col20子进程，我的进程号为2264，我开始执行了...
</div><div class="hljs-line">我是col15子进程，我执行完了！
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">我是col21子进程，我的进程号为21764，我开始执行了...
</div><div class="hljs-line">我是col16子进程，我执行完了！
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">我是col22子进程，我的进程号为21708，我开始执行了...
</div><div class="hljs-line">我是col19子进程，我执行完了！
</div><div class="hljs-line">db_Weibo_SH0331: 已连接！
</div><div class="hljs-line">我是col23子进程，我的进程号为11788，我开始执行了...
</div><div class="hljs-line">我是col21子进程，我执行完了！
</div><div class="hljs-line">我是col20子进程，我执行完了！
</div><div class="hljs-line">我是col22子进程，我执行完了！
</div><div class="hljs-line">我是col23子进程，我执行完了！
</div><div class="hljs-line">主进程结束！
</div><div class="hljs-line">2022-08-28 20:25:37
</div><div class="hljs-line">Time consuming(s): 3221.97
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">Process finished with <span class="hljs-built_in">exit</span> code 0
</div></code></pre>

<h4 id="附录工具">附录工具</h4>

<blockquote>
  <p>怎样查看自己电脑的CPU占用情况呢？</p>
  
  <ul><li><p>两个工具提供</p>
  
  <ol>
  <li rel="1"><p><a href="../../blog/tools/TrafficMonitor_V1.83_x64.zip" target="_blank">TrafficMonitor</a></p></li>
  <li rel="2"><p><a href="../../blog/tools/ProcessExplorer.zip" target="_blank">ProcessExplorer</a></p></li></ol></li>
  </ul>
</blockquote>

<p>示例使用方法：</p>
<img src="../../blog/blogPic/ptView_1.jpg" alt="执行中的占用情况">
<img src="../../blog/blogPic/ptView_2.jpg" alt="执行后的占用情况">
</div>

	
									<!--))))Markdown内容结束-->


								</div><!-- .entry-content -->

							</article><!-- #post-## -->

						</main><!-- #main -->

					</div>
					<!-- #primary -->



				</div><!-- .inside -->
			</div><!-- .container -->
		</div><!-- #content -->

		<footer id="colophon" class="site-footer">

			<aside class="widget-area">
				<div class="container">
					<div class="row">
						<div class="col-4 col-md-4" id="footer-area-1"></div>
						<div class="col-4 col-md-4" id="footer-area-2"></div>
						<div class="col-4 col-md-4" id="footer-area-3"></div>
					</div>
				</div><!-- .container -->
			</aside><!-- .widget-area -->


			<div class="footer-copy">
				<div class="container">

					<div class="row">
						<div class="col-6 col-sm-12">
							<div class="site-credits">
								© 2022 BesT.tao
							</div>
						</div>

						<div class="col-6 col-sm-12"></div>
					</div>

				</div><!-- .container -->
			</div><!-- .footer-copy -->

		</footer><!-- #colophon -->

		<a href="#masthead" id="scroll-up" style="display: block;">
			<i class="material-icons md-20 md-middle"></i>
		</a>

	</div><!-- #page -->

	<div style="display:none"></div>

	<script type="text/javascript"
		src="../../blog/blogJS/wp-content.plugins.jetpack._inc.build.photon.photon.min.js"></script>
	<script type="text/javascript" src="../../blog/blogJS/wp-content.js.devicepx-jetpack.js"></script>
	<script type="text/javascript" src="../../blog/blogJS/wp-content.themes.type-plus.js.main.js"></script>
	<script type="text/javascript" src="../../blog/blogJS/wp-content.themes.type-plus.inc.slick.slick.min.js"></script>
	<script type="text/javascript"
		src="../../blog/blogJS/wp-content.plugins.jetpack._inc.build.widgets.eu-cookie-law.eu-cookie-law.min.js"></script>

	<script type="text/javascript"
		src="../../blog/blogJS/wp-content.plugins.jetpack._inc.build.widgets.milestone.milestone.min.js"></script>
	<script type="text/javascript" src="../../blog/blogJS/wp-includes.js.wp-embed.min.js"></script>
	<script type="text/javascript" src="../../blog/blogJS/stats.wp.com.e-202110.js" async="async"
		defer="defer"></script>

	<!--代码美化-->
	<script src="../../assets/google-code-prettify/prettify.js"></script>

</body>
</html>